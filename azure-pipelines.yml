# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
trigger:
- main
stages:
  - stage: Build
    displayName: Build stage
    jobs:
      - job: Build
        displayName: Build
        pool:
         name: mypool
        steps:
        
        - task: Bash@3
          inputs:
            targetType: 'inline'
            script: |
              # Write your commands here
              
              echo 'Hello world'
            
        - task: Maven@3
          inputs:
            mavenPomFile: 'pom.xml'
            publishJUnitResults: true
            testResultsFiles: '**/surefire-reports/TEST-*.xml'
            javaHomeOption: 'JDKVersion'
            mavenVersionOption: 'Default'
            mavenAuthenticateFeed: false
            effectivePomSkip: false
            sonarQubeRunAnalysis: false
            
        - task: Docker@2
          inputs:
            containerRegistry: 'testing1'
            repository: 'test'
            command: 'build'
            Dockerfile: '**/dockerfile'
            
        - task: Docker@2
          inputs:
            containerRegistry: 'testing1'
            repository: 'test'
            command: 'push'
          
  - stage: deploy
    displayName: Deployment
    jobs:
      - job: Deployment
        displayName: Deploy
        pool:
          name: mypool
        steps:
        
          - task: KubernetesManifest@0
            inputs:
              action: 'createSecret'
              kubernetesServiceConnection: 'spring_dep'
              secretType: 'dockerRegistry'
              secretName: 'acr'
              dockerRegistryEndpoint: 'testing1'
          - task: KubernetesManifest@0
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'spring_dep'
              manifests: '$(System.DefaultWorkingDirectory)/mysql_secret.yaml'


          - task: KubernetesManifest@0
            displayName: maven
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'spring_dep'
              manifests: '$(System.DefaultWorkingDirectory)/maven.yaml'
              containers: '$(containerRegistry)/$(imageRepository2):$(release.artifacts.pkmkumar3.k8-ci.BuildId)'
              imagePullSecrets: 'acr'
              
          - task: Bash@3
            displayName: bash
            inputs:
              targetType: 'inline'
              script: |
                # Write your commands here
                
                echo '$(containerRegistry)/$(imageRepository2):$(release.artifacts.pkmkumar3.k8-ci.BuildId)'
          
        